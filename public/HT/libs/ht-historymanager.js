!function(G,s,d){"use strict";var A="ht",N=G[A],J=N.Default,p=J.def,f=J.getInternal();N.HistoryManager=function(e){this._histories=[],this.setDataModel(e)},p(N.HistoryManager,s,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var G=this;G._betweenTransaction++,1===G._betweenTransaction&&(G._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var O=this,l=O._histories;if(O._betweenTransaction>0&&O._betweenTransaction--,0===O._betweenTransaction){if(O._transactionHistories){var Q=[];for(var r in O._transactionHistories)Q.push(O._transactionHistories[r]);Q.length&&(l=l.slice(0,O._historyIndex+1),l.push(Q),l.length>O._maxHistoryCount&&(l=l.slice(l.length-O._maxHistoryCount)),O.setHistories(l),O.setHistoryIndex(l.length-1,!0))}delete O._transactionHistories}}},setDataModel:function(y){var Q=this,Z=Q._dataModel;Z!==y&&(Z&&(delete Z._historyManager,Z.ump(Q.handleDataModelPropertyChange,Q),Z.umm(Q.$5p,Q),Z.umd(Q.$6p,Q),Z.removeHierarchyChangeListener(Q.handleHierarchyChange,Q),Z.removeIndexChangeListener(Q.handleIndexChange,Q)),Q._dataModel=y,y&&(y._historyManager=Q,y.mp(Q.handleDataModelPropertyChange,Q),y.mm(Q.$5p,Q),y.md(Q.$6p,Q),y.addHierarchyChangeListener(Q.handleHierarchyChange,Q),y.addIndexChangeListener(Q.handleIndexChange,Q)),Q.fp("dataModel",Z,y),Q.clear())},setHistoryIndex:function(B,F){var Y=this,J=Y._historyIndex,P=Y._histories.length;if(-1>B?B=-1:B>=P&&(B=P-1),J!==B){if(!F){var W=B-J;W>0?Y.$2p(W):0>W&&Y.$1p(-W)}Y._historyIndex=B,Y.fp("historyIndex",J,B),Y.dataModel&&Y.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(c){var V=this,J=V._histories,o=V._maxHistoryCount;(!c||0>=c)&&(c=10),o!==c&&(V._maxHistoryCount=c,V.fp("maxHistoryCount",o,c),J.length>c&&V.clear())},cloneValue:function(Y){return N.Default.clone(Y)},isPropertyUndoable:function(w){return w&&!this.ignoredPropertyMap[w]},isDataModelPropertyUndoable:function(U){return U&&!this.ignoreDataModelPropertyMap[U]},$5p:function(T){this.handleChange(T,T.kind)},$6p:function(T){this.handleChange(T,"property")},handleHierarchyChange:function(N){this.handleChange(N,"hierarchy")},handleIndexChange:function(l){this.handleChange(l,"index")},handleDataModelPropertyChange:function(a){this.handleChange(a,"dataModelProperty")},toChildrenInfo:function(r){var V={};return V.data=r,V.children=[],r.eachChild(function(Q){V.children.push(this.toChildrenInfo(Q))},this),V},restoreChildren:function(O){var z=O.data;O.children.forEach(function(O){var H=O.data;H.getParent()!==z&&z.addChild(H),this._dataModel.contains(H)||this._dataModel.add(H),this.restoreChildren(O)},this)},handleChange:function(G,L){var O=this;if(!(O._disabled||O._isUndoRedoing||J.loadingRefGraph)){var Z,z=(O._histories,G.data),b=G.property;if(!z||!(z._refGraph||z instanceof N.RefGraph)){if("property"===L)O.isPropertyUndoable(b,z)&&(Z={kind:L,data:z,property:b,oldValue:O.cloneValue(G.oldValue,z,b),newValue:O.cloneValue(G.newValue,z,b),event:G});else if("hierarchy"===L||"index"===L)Z={kind:L,data:z,oldIndex:G.oldIndex,newIndex:G.newIndex,event:G};else if("clear"===L)Z={kind:L,json:G.json,event:G};else if("add"===L){if(Z={kind:L,data:z,event:G,childrenInfo:this.toChildrenInfo(z),parent:z.getParent()},Z.parent){var D=O._dataModel.getSiblings(z);Z.siblingsIndex=D.indexOf(z)}z instanceof N.Node&&(Z.host=z.getHost(),Z.attaches=z.getAttaches()?z.getAttaches().toArray():d),z instanceof N.Edge&&(Z.source=z.getSource(),Z.target=z.getTarget())}else"remove"===L?Z={kind:L,data:z,event:G}:"dataModelProperty"===L&&O.isDataModelPropertyUndoable(b,z)&&(Z={kind:L,property:b,oldValue:O.cloneValue(G.oldValue,z,b),newValue:O.cloneValue(G.newValue,z,b),event:G});O.addHistory(Z)}}},addHistory:function(T){var W=this;if(T)if(W._betweenTransaction){var U=(T.data?T.data._id:0)+"_"+T.kind+"_"+T.property;if("property"===T.kind||"dataModelProperty"===T.kind){var Q=W._transactionHistories[U];Q&&(T.oldValue=Q.oldValue)}W._transactionHistories[U]=T}else{var C=W._histories;C=C.slice(0,W._historyIndex+1),C.push([T]),C.length>W._maxHistoryCount&&(C=C.slice(C.length-W._maxHistoryCount)),W.setHistories(C),W.setHistoryIndex(C.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(x){(!x||0>=x)&&(x=1),this.setHistoryIndex(this._historyIndex-x)},$1p:function(c){if(this.canUndo()){var m,U=this,D=U._dataModel,Z=U._histories,j=U._historyIndex,z=0;for(U._isUndoRedoing=!0,J.setIsolating(!0);c>0;){if(j>=0&&j<Z.length){z++,m=Z[j],j--;for(var g=m.length-1;g>=0;g--){var A=m[g],O=A.kind,H=A.data,F=A.property,P=A.event,I=this.cloneValue(A.oldValue,H,F);if(A.undo)A.undo();else if("add"===O)D.remove(H,{keepChildren:!0});else if("remove"===O)D.contains(H)||D.add(H,P.rootsIndex,P.datasIndex);else if("clear"===O)D.deserialize(J.clone(A.json));else if("property"===O)if("parent"===F)I?I.addChild(H,P.oldIndex):(H.setParent(I),P.oldIndex>=0&&D.moveTo(H,P.oldIndex));else{var k=null;0===F.indexOf("a:")?(k="attr",F=F.replace("a:","")):0===F.indexOf("s:")?(k="style",F=F.replace("s:","")):0===F.indexOf("f:")&&(k="field",F=F.replace("f:","")),f.setPropertyValue(H,k,F,I)}else if("dataModelProperty"===O){var k=null;0===F.indexOf("a:")?(k="attr",F=F.replace("a:","")):0===F.indexOf("s:")?(k="style",F=F.replace("s:","")):0===F.indexOf("f:")&&(k="field",F=F.replace("f:","")),f.setPropertyValue(D,k,F,I)}else"hierarchy"===O?D.moveTo(H,A.oldIndex):"index"===O&&D.moveToIndex(H,A.oldIndex)}}c--}J.setIsolating(!1),delete U._isUndoRedoing,U.afterUndo(z)}},afterUndo:function(){},redo:function(e){(!e||0>=e)&&(e=1),this.setHistoryIndex(this._historyIndex+e)},$2p:function(A){if(this.canRedo()){var S,_=this,l=_._dataModel,w=_._histories,B=_._historyIndex,v=0;for(_._isUndoRedoing=!0,J.setIsolating(!0);A>0;){if(B>=-1&&B<w.length-1){v++,B++,S=w[B];for(var n=0;n<S.length;n++){var k=S[n],p=k.kind,O=k.data,L=k.property,M=k.event,K=this.cloneValue(k.newValue,O,L);if(k.redo)k.redo();else if("add"===p)k.parent&&!O.getParent()&&k.parent.addChild(O,k.siblingsIndex),l.contains(O)||l.add(O,M.rootsIndex,M.datasIndex),this.restoreChildren(k.childrenInfo),O instanceof N.Node&&(O.setHost(k.host),k.attaches&&k.attaches.forEach(function(Y){Y.setHost(O)})),O instanceof N.Edge&&(O.setSource(k.source),O.setTarget(k.target));else if("remove"===p)l.remove(O);else if("clear"===p)l.clear();else if("property"===p)if("parent"===L)K?K.addChild(O,M.newIndex):(O.setParent(K),M.newIndex>=0&&l.moveTo(O,M.newIndex));else{var c=null;0===L.indexOf("a:")?(c="attr",L=L.replace("a:","")):0===L.indexOf("s:")?(c="style",L=L.replace("s:","")):0===L.indexOf("f:")&&(c="field",L=L.replace("f:","")),f.setPropertyValue(O,c,L,K)}else if("dataModelProperty"===p){var c=null;0===L.indexOf("a:")?(c="attr",L=L.replace("a:","")):0===L.indexOf("s:")?(c="style",L=L.replace("s:","")):0===L.indexOf("f:")&&(c="field",L=L.replace("f:","")),f.setPropertyValue(l,c,L,K)}else"hierarchy"===p?l.moveTo(O,k.newIndex):"index"===p&&l.moveToIndex(O,k.newIndex)}}A--}J.setIsolating(!1),delete _._isUndoRedoing,this.afterRedo(v)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);